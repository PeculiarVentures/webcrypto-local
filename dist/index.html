<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
    <script src="http://cdn.rawgit.com/dcodeIO/protobuf.js/6.6.0/dist/protobuf.js"></script>
    <script src="https://cdn.rawgit.com/jakearchibald/idb/97e4e878/lib/idb.js"></script>
    <script src="https://peculiarventures.github.io/pv-webcrypto-tests/src/promise.js"></script>
    <script src="https://peculiarventures.github.io/pv-webcrypto-tests/src/webcrypto-liner.min.js"></script>
    <script src="https://peculiarventures.github.io/pv-webcrypto-tests/src/asmcrypto.js"></script>
    <script src="https://peculiarventures.github.io/pv-webcrypto-tests/src/elliptic.js"></script>
    <script src="./webcrypto-socket.js"></script>
    <script>
        const PROVIDER_ID = 1;

        var ws = new WebcryptoSocket.SocketProvider();
        ws.connect("127.0.0.1:31337")
            .on("error", (e) => {
                console.error(e.error);
            })
            .on("listening", (e) => {
                ws.isLoggedIn()
                    .then((ok) => {
                        console.log("Is logged in:", ok);
                        if (!ok) {
                            return ws.login();
                        }
                    })
                    .then(() => {
                        // console.info(e.ad1dress);
                        // Test
                        // TestGetCrypto();
                        TestVerify();
                        // TestSign();
                        // TestWrap();
                        // TestDeriveBits();
                        // TestDeriveKey();
                        // TestKeyStorageKeys();
                        // TestKeyStorageIndexOf("private-713400c913c5f0be5183431f7af2b6df236db5095ddb30b37124acfba46e7edd");
                        // TestKeyStorageSetItem();
                        // TestKeyStorageGetItem("private-713400c913c5f0be5183431f7af2b6df236db5095ddb30b37124acfba46e7edd");
                        // TestKeyStorageRemoveItem();
                        // TestKeyStorageClear();
                        // TestCertStorageKeys();
                        // TestCertStorageImportCert();
                        // TestCertStorageIndexOfCert("x509-c53021e4c84bd1a9e9dee840ba6a169f77928f91");
                        // TestCertStorageImportRequest();
                        // TestCertStorageExportCert();
                        // TestCertStorageSetItemCert();
                        // TestCertStorageSetItemRequest();
                        // TestCertStorageRemoveItemCert("request-9cb2b372daea96f94477ee0be4248c23efad5164e5ad738b4076bccde298f244");
                        // TestCertStorageClear();
                        // TestCertStorageGetItemCert("x509-c53021e4c84bd1a9e9dee840ba6a169f77928f91");
                        // TestReset()
                        // TestGetChain()
                        // TestGetCRL()
                        // TestGetOCSP()
                        // TestChainBuilder()
                    })
                    .catch((err) => {
                        console.error(err);
                    })
            })
            .on("token", (info) => {
                if (info.error) {
                    console.error(info.error);
                } else {
                    ws.info()
                        .then((wcInfo) => {
                            console.log(wcInfo);
                        });
                }
            })
            .on("close", (e) => {
                console.info("close");
            });

        const X509_RAW = HexToArray("308203A830820290A003020102020900FEDCE3010FC948FF300D06092A864886F70D01010505003034310B300906035504061302465231123010060355040A0C094468696D796F7469733111300F06035504030C084365727469676E61301E170D3037303632393135313330355A170D3237303632393135313330355A3034310B300906035504061302465231123010060355040A0C094468696D796F7469733111300F06035504030C084365727469676E6130820122300D06092A864886F70D01010105000382010F003082010A0282010100C868F1C9D6D6B3347526821EECB4BEEA5CE126ED114761E1A27C16784021E4609E5AC863E1C4B19692FF186D6923E12B62F7DDE2362F9107B948CF0EEC79B62CE7344B700825A33C871B19F281070F389019D311FE86B4F2D15E1E1E96CD806CCE3B3193B6F2A0D0A995127DA59ACC6BC884568A33A9E722155316F0CC17EC575FE9A20A9809DEE35F9C6FDC48E3850B155AA6BA9FAC48E309B2F7F432DE5E34BE1C785D425BCE0E228F4D90D77D3218B30B2C6ABF8E3F141189200E7714B53D940887F7251ED5B26000EC6F2A28256E2A3E186317253F3E442016F626C825AE054AB4E7632CF38C16537E5CFB111A08C146629F22B8F1C28D69DCFA3A5806DF0203010001A381BC3081B9300F0603551D130101FF040530030101FF301D0603551D0E041604141AEDFE413990B42459BE01F252D545F65A39DC1130640603551D23045D305B80141AEDFE413990B42459BE01F252D545F65A39DC11A138A4363034310B300906035504061302465231123010060355040A0C094468696D796F7469733111300F06035504030C084365727469676E61820900FEDCE3010FC948FF300E0603551D0F0101FF040403020106301106096086480186F8420101040403020007300D06092A864886F70D0101050500038201010085031E9271F642AFE1A3619EEBF3C00FF2A5D4DA95E6D6BE68363D7E6E1F4C8AEFD10F216D5EA55263CE12F8EF2ADA6FEB37FE1302C7CB3B3E226BDA612E7FD4723DDD30E11E4C40198C0FD79CD183307B9859DC7DC6B90C294CA133A2EB673A6584D396E2ED7645708FB52BDEF923D6496E3C14B5C69F351E50D0C18F6A70440262CBAE1D6841A7AA57E853AA07D206F6D514060B9103752C6C72B561959A0D8BB90DE7F5DF54CDDEE6D8D609089763E5C12EB0B74426C026C0AF55309E3BD5362A1904F45C1EFFCF2CB7FFD0FD874011D51123BB48C021A9A4282DFD15F8B04E2BF4305B21FC119134BE41EF7B9D9775FF9795C096582FEABB46D7BBE4D92E");

        const X509_REQUEST_RAW = HexToArray("308202953082017D0201003014311230100603550403130952657175657374203530820122300D06092A864886F70D01010105000382010F003082010A028201010094A897FB367ADE80EC3DAAA356C5A6CE855AA9BC0B8B4B284843A8ECB231DE8EA6DC251F4F8746D341761D609E0717AEE768DD9585638C328D2915F6D33F57ED977ECFE2DC7A79E8C219AF5A6881A26A094E2BB09190452659A3D61300F1E6B9360E926E835BE15830CEC4A2EB859522E7170DA69CB9D21B24F2946150A87D573A913810778739BABE8893AB3096E546396119074F7213790F5EBC5AB7D39AC3BE18C7E4907ECCB817068C68C298D040385B13AB2327C37797AB92C8A6E93C36C88833F9B5EF09B43D324E09153B6425E42C5E535308F33DC6D32939E1AC308F4C5FA759647C802AC5049D779F665ABCE1C7DB4C0530B03C9419ED827AE396890203010001A03C303A06092A864886F70D01090E312D302B30290603551D0E042204200B688932CB3BE42B2CFF528C717C2EC0CFDDC27C8AF70AE9CA56EC9C9AFB73BB300D06092A864886F70D01010B050003820101003F371E9A24F2BDDA4553AD9022BB90308CD69DBE20022B74C64A878AAAD784324F2562F0480C2821FF0DFBD3F1D68F0376C65DD3329D1AFD422386697079D2DF8BF1357A9574C7159DC4D53A1EF6D90DB822DF17F324188CDC163B80D4594F0A9E2A7A9C199E1DDB54CAC3FD1B602DD0B6A1889EB61B5F4DAABF2BC17384F3157C5E49B601EADEB289CF3DE08F362BDCCE1EF3BCFCDC3302148E36B87A8D8ECD46B5B5E3CD28349394E7008DFB41D5627FAF3E88C6641C2C2207D0BFCE3E914939352CBCCDEF043BD72AB2ADDB0690DBE998283BED4A9C6A74135E5FC4CA03A0EA46AF905DF8E9DD8D1F14F7ABCDB6D8D5A683031FA19AC255595B233657F064");

        function HexToArray(hexString) {
            var res = new Uint8Array(hexString.length / 2);
            for (var i = 0; i < hexString.length; i = i + 2) {
                var c = hexString.slice(i, i + 2);
                res[i / 2] = parseInt(c, 16);
            }
            return res.buffer;
        }

        function ArrayToHex(array) {
            let res = "";
            array = new Uint8Array(array);

            array.forEach(function (byte) {
                let hex = byte.toString(16);
                if (hex.length === 1) {
                    hex = "0" + hex;
                }
                res += hex;
            });
            return res;
        }

        function TestGetCrypto() {
            var provider;
            ws.info()
                .then((info) => {
                    console.log("Providers:", info);
                    provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    console.log(crypto);
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                console.log("Crypto is not logged in");
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.digest("SHA-256", new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8, 9, 0]))
                        })
                        .then((hash) => {
                            console.log(new Uint8Array(hash));
                            const res = prompt("Doyou realy want to clear your '" + provider.name + "'?\nPrint 'yes' or 'no'");
                            if (res && res.toString().toLowerCase() === "yes") {
                                return crypto.certStorage.clear()
                                    .then(() => {
                                        return crypto.keyStorage.clear()
                                    })
                            }
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestGenerateKey() {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["sign", "verify"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, false, usages);
                        })
                        .then((keys) => {
                            console.log(keys);
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestVerify() {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["verify"];
            const jwk = {
                "kty": "RSA",
                "alg": "RS256",
                "ext": true,
                "key_ops": [
                  "verify"
                ],
                "e": "AQAB",
                "n": "sH7FlA4mVSSP3luMNM1L0orpiUllBDLg4IbYPOIvccbM5s9hmOeawLkwYmwLcu5qjwqaTOwmbw4vCcVA1q1HwS4fMEiV38E94XY90f_bf6s8QL0f_TuGEnEjP8Wyob0oKmc6haBs8iChJ08T3kw5roOH7RQ80xBVqjxcqTgkov7qzLvo40gk_sF1Mzy4Kxu9rSwPY3yWpOf28HURu-9wjBHYi_Zuhx7c9Qz5Kay_xXpi8z9xL95MwQYFT1Smug2AGMLy7OadzOUZ2w827U91E8HUj1uYER6PaHui3WNtGatenk_z5ZFwB3TlDwjljpsymLanQHA-XFCBkpLLzmlDfw"
              };
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.importKey("jwk", jwk, alg, true, usages);
                        })
                        .then((key) => {
                            const data = new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8, 9, 0]);
                            const sig = HexToArray("354c9cca44e0cd753ff56188b9a166d3e0c2cee89acf0312588c4b13aff952d9a31d303596b077546363b44941f34178c316cf2b9665508be1770ab5d2bb680d693dbbecc644d776d8cec550a4f189100af81837f05dc1c54ee0aebe05255e92d81d713059923411f985d48ac216c8e9660a801da4f091f42eed6c8956327b97acd80d99bf5c27a73606584849a543e669055f2a5dd6966473661817eae4ae49e303ecfaa13c3fc4179b947de6c5fe031fd901aa488cc3059e1f30fc5e4fb65ec24e6246502493ff655ac38650c005070f057c298c1edb0a3149d00a91f1bcd7eac8070b568433dab6351f29a1883582a5afd093572c4d4cf33379b9c2a229c9");
                            return crypto.subtle.verify(alg, key, sig, data)
                                .then((ok) => {
                                    console.log("Signature:", ok);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestSign() {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["sign", "verify"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, false, usages);
                        })
                        .then((keys) => {
                            const data = new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8, 9, 0]);
                            return crypto.subtle.sign(alg, keys.privateKey, data)
                                .then((sig) => {
                                    console.log(ArrayToHex(sig));
                                    return crypto.subtle.verify(alg, keys.publicKey, sig, data);
                                })
                                .then((ok) => {
                                    console.log("Signature:", ok);
                                    return crypto.subtle.exportKey("jwk", keys.publicKey)
                                        .then((jwk) => {
                                            console.log(JSON.stringify(jwk, null, "  "));
                                        });
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestEncrypt() {
            const alg = { name: "AES-CBC", length: 256, iv: new ArrayBuffer(16) };
            const usages = ["encrypt", "decrypt"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, false, usages);
                        })
                        .then((key) => {
                            const data = new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8, 9, 0]);
                            return crypto.subtle.encrypt(alg, key, data)
                                .then((enc) => {
                                    return crypto.subtle.decrypt(alg, key, enc);
                                })
                                .then((dec) => {
                                    console.log("Data:", new Uint8Array(dec));
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestWrap() {
            const alg = { name: "AES-CBC", length: 256, iv: new ArrayBuffer(16) };
            const usages = ["encrypt", "decrypt", "wrapKey", "unwrapKey"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, true, usages);
                        })
                        .then((key) => {
                            return crypto.subtle.wrapKey("raw", key, key, alg)
                                .then((enc) => {
                                    return crypto.subtle.unwrapKey("raw", enc, key, alg, alg, false, ["encrypt"]);
                                })
                                .then((k) => {
                                    console.log("Key:", k);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestDeriveBits() {
            const alg = { name: "ECDH", namedCurve: "P-256" };
            const usages = ["deriveBits", "deriveKey"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, false, usages);
                        })
                        .then((keys) => {
                            alg.public = keys.publicKey;
                            console.log(alg);
                            return crypto.subtle.deriveBits(alg, keys.privateKey, 128)
                                .then((bits) => {
                                    console.log("Bits:", new Uint8Array(bits));
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestDeriveKey() {
            const alg = { name: "ECDH", namedCurve: "P-256" };
            const usages = ["deriveBits", "deriveKey"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID]
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, false, usages);
                        })
                        .then((keys) => {
                            alg.public = keys.publicKey;
                            console.log(alg);
                            return crypto.subtle.deriveKey(alg, keys.privateKey, { name: "AES-CBC", length: 256 }, false, ["encrypt", "decrypt"])
                                .then((key) => {
                                    console.log("Derived key:", key);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestKeyStorageSetItem() {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["sign", "verify"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.subtle.generateKey(alg, false, usages);
                        })
                        .then((keys) => {
                            console.log(keys);
                            return crypto.keyStorage.keys()
                                // .then((names) => {
                                // return crypto.keyStorage.keys();
                                // })
                                .then((names) => {
                                    console.log("Keys before setItem", names);
                                    return crypto.keyStorage.setItem(keys.privateKey);
                                })
                                .then(() => {
                                    return crypto.keyStorage.setItem(keys.publicKey);
                                })
                                .then((index) => {
                                    return crypto.keyStorage.keys();
                                })
                                .then((names) => {
                                    console.log("Keys after setItem", names);
                                });
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestKeyStorageKeys() {
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.keyStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestKeyStorageIndexOf(itemIndex) {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-384", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["sign", "verify"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.keyStorage.keys()
                                .then((names) => {
                                    console.log("Keys:", names);
                                    return crypto.keyStorage.getItem(itemIndex, alg, ["sign"]);
                                })
                                .then((key) => {
                                    console.log("CryptoKey:", key);
                                    if (key) {
                                        return crypto.keyStorage.indexOf(key);
                                    } else {
                                        throw new Error("Key is not found");
                                    }
                                })
                                .then((index) => {
                                    console.log("Index:", index);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestKeyStorageGetItem(itemIndex) {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-384", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["sign", "verify"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.keyStorage.keys()
                                .then((names) => {
                                    console.log("Keys:", names);
                                    return crypto.keyStorage.getItem(itemIndex, alg, ["sign"]);
                                    // return crypto.keyStorage.getItem(itemIndex); // default
                                })
                                .then((key) => {
                                    console.log("Key:", key);
                                    return crypto.subtle.sign(alg, key, new ArrayBuffer(12));
                                })
                                .then((signature) => {
                                    console.log("Signature:", new Uint8Array(signature));
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestKeyStorageClear() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.keyStorage.keys()
                                .then((names) => {
                                    console.log("Keys:", names);
                                    return crypto.keyStorage.clear();
                                })
                                .then(() => {
                                    return crypto.keyStorage.keys()
                                })
                                .then((indexs) => {
                                    console.log("Keys:", indexs);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestKeyStorageRemoveItem() {
            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256", publicExponent: new Uint8Array([1, 0, 1]), modulusLength: 2048 };
            const usages = ["sign", "verify"];
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.keyStorage.keys()
                                .then((names) => {
                                    console.log("Keys:", names);
                                    return crypto.subtle.generateKey(alg, false, ["sign", "verify"]);
                                })
                                .then((keys) => {
                                    return crypto.keyStorage.setItem(keys.privateKey)
                                })
                                .then((index) => {
                                    return crypto.keyStorage.keys()
                                        .then((indexes) => {
                                            console.log(indexes);
                                            return crypto.keyStorage.removeItem(index);
                                        });
                                })
                                .then((key) => {
                                    return crypto.keyStorage.keys()
                                })
                                .then((names) => {
                                    console.log("Keys:", names);
                                });
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageKeys() {
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageImportCert() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.importCert("x509", X509_RAW, alg, ["verify"])
                                })
                                .then((cert) => {
                                    console.log(cert);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageImportRequest() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.importCert("request", X509_REQUEST_RAW, alg, ["verify"])
                                })
                                .then((cert) => {
                                    console.log(cert);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageExportCert() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.importCert("x509", X509_RAW, alg, ["verify"])
                                })
                                .then((cert) => {
                                    console.log(cert);
                                    return crypto.certStorage.exportCert("pem", cert);
                                })
                                .then((raw) => {
                                    if (raw instanceof ArrayBuffer) {
                                        console.log("Certificate raw:", new Uint8Array(raw));
                                    } else {
                                        console.log(raw);
                                    }
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageSetItemCert() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.importCert("x509", X509_RAW, alg, ["verify"])
                                })
                                .then((cert) => {
                                    console.log("Certificate:", cert);
                                    return crypto.certStorage.setItem(cert);
                                })
                                .then((index) => {
                                    console.log("Certificate index:", index);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageSetItemRequest() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Items:", names);
                                    return crypto.certStorage.importCert("request", X509_REQUEST_RAW, alg, ["verify"])
                                })
                                .then((cert) => {
                                    console.log("Request:", cert);
                                    return crypto.certStorage.setItem(cert);
                                })
                                .then((index) => {
                                    console.log("Request index:", index);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageRemoveItemCert(itemId) {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.removeItem(itemId);
                                })
                                .then(() => {
                                    return crypto.certStorage.keys()
                                })
                                .then((indexs) => {
                                    console.log("Certificates:", indexs);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageClear() {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.clear();
                                })
                                .then(() => {
                                    return crypto.certStorage.keys()
                                })
                                .then((indexs) => {
                                    console.log("Certificates:", indexs);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageGetItemCert(itemId) {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.getItem(itemId, alg, ["verify"]);
                                    // return crypto.certStorage.getItem(itemId); // default alg, usage
                                })
                                .then((cert) => {
                                    console.log(cert);
                                    return crypto.subtle.verify(alg, cert.publicKey, new ArrayBuffer(256), new ArrayBuffer(5));
                                })
                                .then((ok) => {
                                    console.log("Verification:", ok);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestCertStorageIndexOfCert(itemId) {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                    return crypto.certStorage.getItem(itemId, alg, ["verify"]);
                                })
                                .then((cert) => {
                                    return crypto.certStorage.indexOf(cert);
                                })
                                .then((index) => {
                                    console.log("Index:", index);
                                });
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestReset(itemId) {
            var alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };

            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                })
                        })
                        .then(() => {
                            alert("Insert SmartCard and click OK");
                            return crypto.reset();
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                                .then((names) => {
                                    console.log("Certificates:", names);
                                })
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestGetChain() {
            const certIndex = 8;
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                        })
                        .then((keys) => {
                            return crypto.certStorage.getItem(keys[certIndex]);
                        })
                        .then((item) => {
                            console.log("Entry certificate before chain buid:\n\tsubject: %s\n\tissuer: %s", item.subjectName, item.issuerName);
                            return crypto.certStorage.getChain(item);
                        })
                        .then((chain) => {
                            console.log(chain);
                            const alg = { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };
                            const promises = [];
                            for (const certDer of chain) {
                                promises.push(
                                    crypto.certStorage.importCert("x509", certDer.value, alg, ["verify"])
                                        .then((cert) => {
                                            console.log("Certificate:\n\tsubject: %s\n\tissuer: %s", cert.subjectName, cert.issuerName);
                                        })
                                );
                            }
                            return Promise.all(promises);
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestGetCRL() {
            const certIndex = 0;
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.getCRL("http://localhost:3001/crl_ca.pem")
                        })
                        .then((crl) => {
                            console.log(crl);
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
        function TestGetOCSP() {
            const certIndex = 0;
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            const ocspRequest = HexToArray("3060305EA122A420301E311C3009060355040613025255300F06035504031E080054006500730074301F301D301B300706052B0E03021A04047F01020304047F01020302047F010203A2173015301306092B0601050507300102040604047F010203");
                            return crypto.certStorage.getOCSP("http://ocsp.apple.com/ocsp03-wwdr01", ocspRequest, { method: "post" });
                        })
                        .then((ocsp) => {
                            console.log(ArrayToHex(ocsp));
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function TestChainBuilder() {
            const certIndex = 5;
            ws.info()
                .then((info) => {
                    const provider = info.providers[PROVIDER_ID];
                    console.log("Provider:", provider);
                    return ws.getCrypto(provider.id);
                })
                .then((crypto) => {
                    return crypto.isLoggedIn()
                        .then((ok) => {
                            if (!ok) {
                                return crypto.login();
                            }
                        })
                        .then(() => {
                            return crypto.certStorage.keys()
                        })
                        .then((keys) => {
                            return crypto.certStorage.getItem(keys[certIndex]);
                        })
                        .then((item) => {
                            console.log(item);
                            return WebcryptoSocket.ChainBuild(item);
                        })
                })
                .catch((err) => {
                    console.log(err);
                });
        }
    </script>
</body>

</html>